
@page "/"
@inject IWorkOrdersService Service

<h1>Printing Jobs</h1>

<div class="filters">
    <label>Status:
        <select @onchange="OnStatusChanged">
            <option value="">(All)</option>
            @foreach (var s in Enum.GetValues<JobStatus>())
            {
                <option value="@s.ToString()" selected="@(s==Selected ? true : false)">@s</option>
            }
        </select>
    </label>
</div>

@if (Jobs is null)
{
    <p>Loading...</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>JobId</th><th>Client</th><th>Job</th><th>Qty</th>
                <th>Status</th><th>Created</th><th>Carrier</th><th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var j in Jobs)
        {
            <tr>
                <td>@j.Id</td>
                <td>@j.ClientName</td>
                <td><a href="/workorders/details/@j.Id">@j.JobName</a></td>
                <td>@j.Quantity</td>
                <td><span class="badge @GetBadge(j.CurrentStatus)">@j.CurrentStatus</span></td>
                <td>@j.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                <td>@j.Carrier</td>
                <td>
                    <button @onclick="() => Advance(j.Id)" disabled="@(j.CurrentStatus is JobStatus.Delivered or JobStatus.Exception)">Advance</button>
                    <button @onclick="() => MarkException(j.Id)" disabled="@(j.CurrentStatus is JobStatus.Exception)">Exception</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    private List<PrintingJobTracker.Domain.Job>? Jobs;
    private JobStatus? Selected;

    protected override async Task OnInitializedAsync()
    {
        Jobs = await Service.GetJobsAsync();
    }

    private async Task OnStatusChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value)) Selected = null;
        else Selected = Enum.Parse<JobStatus>(value);
        Jobs = await Service.GetJobsAsync(Selected);
    }

    private async Task Advance(int id)
    {
        await Service.AdvanceStatusAsync(id);
        Jobs = await Service.GetJobsAsync(Selected);
    }

    private async Task MarkException(int id)
    {
        var note = await JS.InvokeAsync<string?>("prompt", "Enter exception note:");
        if (string.IsNullOrWhiteSpace(note)) return;
        await Service.MarkExceptionAsync(id, note!);
        Jobs = await Service.GetJobsAsync(Selected);
    }

    [Inject] private Microsoft.JSInterop.IJSRuntime JS { get; set; } = default!;

    string GetBadge(JobStatus s) => s switch
    {
        JobStatus.Received => "badge-received",
        JobStatus.Printing => "badge-printing",
        JobStatus.Inserting => "badge-inserting",
        JobStatus.Mailed => "badge-mailed",
        JobStatus.Delivered => "badge-delivered",
        JobStatus.Exception => "badge-exception",
        _ => ""
    };
}
