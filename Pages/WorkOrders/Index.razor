@using PrintingJobTracker.Shared
@using Microsoft.AspNetCore.Components.Forms
@using PrintingJobTracker.Models
@using System
@page "/workorders"
@using PrintingJobTracker.Application.WorkOrders
@inject IWorkOrdersService Service
@inject NavigationManager Nav

<h1 class="mb-3">Work Orders</h1>

<div class="row g-2 mb-2">
  <div class="col-12 col-md-4">
    <StatusFilter @bind-Value="_statusStr" />
  </div>
  <div class="col-12 col-md-6">
    <SearchBox @bind-Text="_search" />
  </div>
  <div class="col-12 col-md-2 text-end">
    <a class="btn btn-primary w-100" href="/workorders/new">New</a>
  </div>
</div>

<div class="table-responsive">
<table class="table table-striped align-middle">
  <thead>
    <tr>
      <th>Id</th>
      <th>ClientName</th>
      <th>JobName</th>
      <th>Quantity</th>
      <th>Carrier</th>
      <th>CurrentStatus</th>
      <th>CreatedAt</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  @if (_items is null)
  {
    <tr><td colspan="8">Loading...</td></tr>
  }
  else if (_items.Count == 0)
  {
    <tr><td colspan="8">No results.</td></tr>
  }
  else
  {
    @foreach (var it in _items)
    {
      <tr>
        <td>@it.Id</td>
        <td>@it.ClientName</td>
        <td>@it.JobName</td>
        <td>@it.Quantity</td>
        <td>@it.Carrier</td>
        <td><span class="badge badge-status @GetBadge(it.CurrentStatus)">@it.CurrentStatus</span></td>
        <td>@it.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-success me-1" @onclick="() => Advance(it.Id)" disabled="@(it.CurrentStatus == JobStatus.Delivered || it.CurrentStatus == JobStatus.Exception)">Next</button>
          <button class="btn btn-sm btn-outline-danger me-1" @onclick="() => MarkException(it.Id)">Exception</button>
          <a class="btn btn-sm btn-outline-primary" href="@($"/workorders/{it.Id}")">Details</a>
        </td>
      </tr>
    }
  }
  </tbody>
</table>
</div>

<Pager Page="_page" PageSize="_pageSize" Total="_total" PageChanged="OnPageChanged" />

@code {

    private List<Job> _items = new();
    private string? _search;
    private JobStatus? _status = null;

    protected override async Task OnInitializedAsync()
    {
        _items = await Service.GetWorkOrdersAsync(_status);
    }

    private async Task OnFilterChanged()
    {
        _items = await Service.GetWorkOrdersAsync(_status);
        StateHasChanged();
    }


    private string? _statusStr;
    private JobStatus? StatusFilterEnum => Enum.TryParse<JobStatus>(_statusStr, out var s) ? s : (JobStatus?)null;

    private string GetBadge(JobStatus status) => status switch
    {
        JobStatus.Received  => "badge-received",
        JobStatus.Printing  => "badge-printing",
        JobStatus.Inserting => "badge-inserting",
        JobStatus.Mailed    => "badge-mailed",
        JobStatus.Delivered => "badge-delivered",
        _ => "badge-secondary"
    };

    private async Task Advance(int id)
    {
        await Service.AdvanceStatusAsync(id);
        _items = await Service.GetWorkOrdersAsync(StatusFilterEnum);
        StateHasChanged();
    }

    private async Task MarkException(int id)
    {
        await Service.MarkExceptionAsync(id, "Marked from UI");
        _items = await Service.GetWorkOrdersAsync(StatusFilterEnum);
        StateHasChanged();
    }
}